---
title: "Minsa-medidas"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(ggplot2)
library(plotly)

minsem=202008
maxsem=202113

cdc=readRDS("falles_casos.RDS")
cdcPos=aggregate(data=cdc,pos~semana,sum)
cdcFalle=aggregate(data=cdc,falles_cov~semana,sum)
cdcInmo=aggregate(data=cdc,inmo~semana,mean)
cdcuci=aggregate(data=cdc,uci~semana,mean)
cdcbed=aggregate(data=cdc,cam~semana,mean)
cdcPosFalle=merge(cdcPos,cdcFalle)
cdcPosFalle=merge(cdcPosFalle,cdcInmo)
cdcPosFalle=merge(cdcPosFalle,cdcbed)
cdcPosFalle=merge(cdcPosFalle,cdcuci)
cdcPosFalle=cdcPosFalle[cdcPosFalle$semana>=minsem & cdcPosFalle$semana<=maxsem,]
cdcPosFalle$semana=as.ordered(cdcPosFalle$semana)
base=ggplot(data=cdcPosFalle) + theme_minimal() + theme(axis.title.y = element_blank()) +xlab("Año-Semana") 

library(ggpmisc)


```


Movilidad / Casos / Fallecidos
=====================================


Row {data-height=350}
-----------------------------------------------------------------------

### Casos Confirmados (conteo)

```{r, echo=FALSE}

casos=base+geom_line(aes(x=semana,
                        y=pos,group=1),color='pink')
casos=casos+stat_valleys(aes(x=semana,
                        y=pos,group=1),span=3,size=0.5,colour = "red")
casos1=casos+theme(axis.text.x = element_blank(),
               axis.title.x = element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank()
               
               ) + geom_vline(xintercept = 47, color='grey',linetype=2)

ggplotly(casos1,tooltip = c("semana","pos"))
```

### Fallecidos Covid (conteo)

```{r}

falles=base+geom_line(aes(x=semana,
                        y=falles_cov,group=1), color="grey80")

falles=falles+stat_valleys(aes(x=semana,
                        y=falles_cov,group=1),span=3,size=0.5,colour = "black")
falles1=falles+theme(axis.text.x = element_blank(),
               axis.title.x = element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank()
               ) + geom_vline(xintercept = 47, color='grey',linetype=2)

ggplotly(falles1,tooltip = c("semana","falles_cov"))


```

### Movilidad (% Permanencia en Casa si 0 es permanencia antes de pandemia)

```{r}

movil=base+geom_line(aes(x=semana,
                        y=inmo,group=1), color="cyan3")

movil=movil+stat_valleys(aes(x=semana,
                        y=inmo,group=1),span=3,size=0.5,colour = "blue")
movil1=movil+theme(axis.text.x = element_blank(),
               axis.title.x = element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank()
               ) + geom_vline(xintercept = 47, color='grey',linetype=2) + ylim(0,100)

ggplotly(movil1,tooltip = c("semana","inmo"))


```



Row {data-height=650}
-----------------------------------------------------------------------

### Comparación Casos / Fallecidos / Movilidad (EJE Y en escala Logaritmica)

```{r}
both=base+geom_line(aes(x=semana,
                        y=falles_cov,group=1),
                    color='grey80')
both=both+stat_valleys(aes(x=semana,
                        y=falles_cov,group=1),
                     span=3,colour = "black")
both=both+geom_line(aes(x=semana,
                        y=pos,group=1),color='pink')
both=both+stat_valleys(aes(x=semana,
                        y=pos,group=1),
                     span=3,colour = "red")

both=both+geom_line(aes(x=semana,
                        y=inmo,group=1), color="cyan3")

both=both+stat_valleys(aes(x=semana,
                        y=inmo,group=1),span=3,colour = "blue")


both=both+theme(axis.text.x = element_text(angle = 80,
                                           size = 6,
                                           vjust = 0.5,
                                           hjust = 0.5))
both=both + scale_y_log10()+ geom_vline(xintercept = 47, color='grey',linetype=2)

ggplotly(both,tooltip = c("semana","pos","falles_cov","inmo"))

```


Movilidad / Camas / UCIs
=====================================


Row {data-height=350}
-----------------------------------------------------------------------

### Camas covid (% ocupación)

```{r}

cam=base+geom_line(aes(x=semana,
                        y=cam,group=1), color="chartreuse")

cam=cam+stat_valleys(aes(x=semana,
                        y=cam,group=1),span=3,size=0.5,colour = "darkgreen")
cam1=cam+theme(axis.text.x = element_blank(),
               axis.title.x = element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank()
               ) + geom_vline(xintercept = 47, color='grey',linetype=2) + ylim(0,100)

ggplotly(cam1,tooltip = c("semana","cam"))


```

### UCI covid (% ocupación)

```{r}

uci=base+geom_line(aes(x=semana,
                        y=uci,group=1), color="darkgoldenrod2")

uci=uci+stat_valleys(aes(x=semana,
                        y=uci,group=1),span=3,size=0.5,colour = "chocolate")
uci1=uci+theme(axis.text.x = element_blank(),
               axis.title.x = element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank()
               ) + geom_vline(xintercept = 47, color='grey',linetype=2) + ylim(0,100)

ggplotly(uci1,tooltip = c("semana","uci"))


```


### Movilidad (% Permanencia en Casa si 0 es permanencia antes de pandemia)

```{r}

movil=base+geom_line(aes(x=semana,
                        y=inmo,group=1), color="cyan3")

movil=movil+stat_valleys(aes(x=semana,
                        y=inmo,group=1),span=3,size=0.5,colour = "blue")
movil1=movil+theme(axis.text.x = element_blank(),
               axis.title.x = element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank()
               ) + geom_vline(xintercept = 47, color='grey',linetype=2) + ylim(0,100)

ggplotly(movil1,tooltip = c("semana","inmo"))


```

Row {data-height=650}
-----------------------------------------------------------------------

### Comparación (%)

```{r}
both2=base+geom_line(aes(x=semana,
                        y=inmo,group=1), color="cyan3")

both2=both2+stat_valleys(aes(x=semana,
                        y=inmo,group=1),span=3,colour = "blue")

both2=both2+geom_line(aes(x=semana,
                        y=cam,group=1), color="chartreuse")

both2=both2+stat_valleys(aes(x=semana,
                        y=cam,group=1),span=3,colour = "darkgreen")

both2=both2+geom_line(aes(x=semana,
                        y=uci,group=1), color="darkgoldenrod2")

both2=both2+stat_valleys(aes(x=semana,
                        y=uci,group=1),span=3,colour = "chocolate")



both2=both2+theme(axis.text.x = element_text(angle = 80,
                                           size = 6,
                                           vjust = 0.5,
                                           hjust = 0.5))
both2=both2 + geom_vline(xintercept = 47, color='grey',linetype=2)

ggplotly(both2,tooltip = c("semana","uci","cam","inmo"))

```


Edad y Lugar de Fallecimiento
=====================================

```{r, echo=FALSE}

falleloc=cdc[,c("semana","falle_casa","falle_salud","falle_otro")]
falleloc=aggregate(data=falleloc,.~semana,sum)
falleloc=reshape2::melt(falleloc,id.vars="semana")

falleloc=falleloc[falleloc$semana>=minsem & falleloc$semana<=maxsem,]
falleloc$semana=as.ordered(falleloc$semana)
levels(falleloc$variable)=c("En casa","En Servicio de Salud", "Otro")
falleloc$variable=as.ordered(falleloc$variable)
base2=ggplot(data=falleloc) + theme_minimal() + theme(axis.title.y = element_blank()) +xlab("Año-Semana") 


falledad=cdc[,c("semana","falle_menores_cov","falle_18_30_cov","falle_30_50_cov",
                "falle_50_65_cov","falle_65_80_cov","falle_mas80_cov")]

falledad=aggregate(data=falledad,.~semana,sum)
falledad=reshape2::melt(falledad,id.vars="semana")

falledad=falledad[falledad$semana>=minsem & falledad$semana<=maxsem,]
falledad$semana=as.ordered(falledad$semana)


newlevels=gsub(pattern = "falle_",replacement = "",levels(falledad$variable))
newlevels=gsub(pattern = "_cov",replacement = "",newlevels)
newlevels=gsub(pattern = "_",replacement = "-",newlevels)

levels(falledad$variable)=newlevels

falledad$variable <- factor(falledad$variable, levels=rev(levels(falledad$variable)),ordered = T)

base3=ggplot(data=falledad) + theme_minimal() + theme(axis.title.y = element_blank()) +xlab("Año-Semana")

```


### Fallecidos segun lugar

```{r}
where=base2+ geom_bar(aes(x = semana,
                          y = value,
                          fill = variable),
                      stat="identity",position="fill") 
where=where + theme(legend.position="top",
                    legend.title = element_blank(),
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank(),
                    panel.background = element_blank(),
                    axis.text.x = element_text(angle = 80,
                                               size = 6,
                                               vjust = 0.5,
                                           hjust = 0.5)) 

where


```

### Fallecidos segun Edad

```{r}
age=base3+ geom_bar(aes(x = semana,
                          y = value,
                          fill = variable),
                      stat="identity",position="fill") 
age=age + theme(legend.position="top",
                    legend.title = element_blank(),
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank(),
                    panel.background = element_blank(),
                    axis.text.x = element_text(angle = 80,
                                               size = 6,
                                               vjust = 0.5,
                                           hjust = 0.5)) 

age


```