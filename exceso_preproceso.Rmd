

```{r}
#names(sinall)
```


```{r}
library(reshape2)
sinall=foreign::read.dbf("CDEFRA.dbf",as.is = T)

columnsSelected=c("TIPOSEGURO","SEXO","ETNIA","OCUPACION","PAISDOMICI","FECHA","TIPOLUGAR","DEPARTAMEN","PROVINCIA","DISTRITO_I","EDAD_A","DIRESA","DIRESAS_MI","SEDEF","CORONAVIRU")
#"INSTITUCIO"
sinall=sinall[,columnsSelected]
sinall$FECHA=as.Date(sinall$FECHA,format="%Y-%m-%d")
#
names(sinall)=stri_trans_general(names(sinall),id = "Latin-ASCII")
#
sinall$OCUPACION=stri_trans_general(sinall$OCUPACION,id = "Latin-ASCII")
#
sinall$OCUPACION=gsub("�_","N",sinall$OCUPACION,fixed = T)
#
#
#

ALLCATS=names(table(sinall$OCUPACION))
PATTERN_ok="AVIAC|EJERCITO|MARINA|POLICIA|MEDICO|ENFERMER|PARAMEDICO|PSICO"
#BOMBER|

interes=ALLCATS[grep(PATTERN_ok,ALLCATS)]

PATTERN_NOK="VISITADOR|SECRETAR|MERCANT|PROFESOR|RECEPCIONISTA"
interesNO=ALLCATS[grep(PATTERN_NOK,ALLCATS)]

interes=setdiff(interes,interesNO)

sinall$ocupa_primera=ifelse(sinall$OCUPACION%in%interes,1,0)

saludSel="PSICO|MEDICO|ENFERMER|PARAMEDICO"
seguSel="AVIAC|EJERCITO|MARINA|POLICIA"

interesSalud=interes[grep(saludSel,interes)]
interesSegur=interes[grep(seguSel,interes)]

sinall$Cate=0
sinall[sinall$OCUPACION%in%interesSalud,"Cate"]=1
sinall[sinall$OCUPACION%in%interesSegur,"Cate"]=2

sinall[sinall$PAISDOMICI!="PERU","PAISDOMICI"]="EXTRANJERO"

sinall$Lugar=10
sinall[sinall$PROVINCIA!="LIMA" & !is.na(sinall$PROVINCIA),"Lugar"]=20

sinall$CateLug=sinall$Cate + sinall$Lugar


sinall$PROVINCIA=gsub("\xc7'","Ñ",sinall$PROVINCIA)







sinall$año=epiyear(sinall$FECHA)
sinall$semana=epiweek(sinall$FECHA)
sinall$anosem=sinall$año*100+sinall$semana

sinall=sinall[complete.cases(sinall$DEPARTAMEN),]
sinall=sinall[complete.cases(sinall$EDAD_A),]
sinall[!complete.cases(sinall$DEPARTAMEN),"TIPOLUGAR"]="IGNORADO"


sinall[sinall$DIRESA=='"BUENOS AIRES',"DIRESA"]="SIN REGISTRO"
sinall[sinall$PROVINCIA=="EXTRANJERO" &!is.na(sinall$PROVINCIA),"PROVINCIA"]="SIN REGISTRO"
sinall[sinall$DEPARTAMEN=="EXTRANJERO"&!is.na(sinall$DEPARTAMEN),"DEPARTAMEN"]="SIN REGISTRO"

sinall[sinall$DEPARTAMEN=='"BUENOS AIRES',"DEPARTAMEN"]="SIN REGISTRO"

sinall[sinall$PROVINCIA=='ARICA' & !is.na(sinall$PROVINCIA),"PROVINCIA"]="SIN REGISTRO"

sinall[sinall$DIRESAS_MI=='"BUENOS AIRES'&!is.na(sinall$DIRESAS_MI),"DIRESAS_MI"]="SIN REGISTRO"


saveRDS(sinall,file = "sinadef.rds")
rm(list = ls())

```

```{r}
sindat=readRDS("sinadef.rds")

sindat=sindat[complete.cases(sindat$DIRESAS_MI),]
sindat=sindat[complete.cases(sindat$PROVINCIA),]
sindat=sindat[sindat$PROVINCIA!="SIN REGISTRO",]

```



```{r}
sindat_anual_primera=sindat%>%group_by(año,semana,anosem) %>%summarize(
      primera_linea=length(ocupa_primera[ocupa_primera==1]),
      otra_actividad=length(ocupa_primera[ocupa_primera==0])
      )
sindat_anual_primera=sindat_anual_primera[sindat_anual_primera$anosem<=202118,]
sindat_anual_primera$anosem=NULL
sindat_anual_primera=melt(sindat_anual_primera,id.vars = c("año","semana"))

saveRDS(sindat_anual_primera,file="sindat_anual_primera.rds")

```


```{r}
sindat_anual=sindat%>%
            group_by(año,semana,anosem) %>%summarize(
      fallecidos=length(semana)
      )
sindat_anual=sindat_anual[sindat_anual$anosem<202118,]
saveRDS(sindat_anual,file="sindat_anual.rds")
```






```{r}
sindat_tabla_prov=sindat%>%
            group_by(año,PROVINCIA) %>%summarize(
      fallecidos=length(PROVINCIA)
      )

###

table2017=sindat_tabla_prov[sindat_tabla_prov$año==2017,]
table2017=table2017[order(-table2017$fallecidos),]

table2017$cum2017=cumsum(table2017$fallecidos)/sum(table2017$fallecidos)

table2017$rk2017=as.numeric(row.names(table2017))
table2017$pareto2017=0
table2017[table2017$cum2017<=0.8,'pareto2017']=1
names(table2017)[3]="fallecidos2017"
table2017$año=NULL
###
table2018=sindat_tabla_prov[sindat_tabla_prov$año==2018,]
table2018=table2018[order(-table2018$fallecidos),]

table2018$cum2018=cumsum(table2018$fallecidos)/sum(table2018$fallecidos)

table2018$rk2018=as.numeric(row.names(table2018))
table2018$pareto2018=0
table2018[table2018$cum2018<=0.8,'pareto2018']=1
names(table2018)[3]="fallecidos2018"
table2018$año=NULL

###
table2019=sindat_tabla_prov[sindat_tabla_prov$año==2019,]
table2019=table2019[order(-table2019$fallecidos),]

table2019$cum2019=cumsum(table2019$fallecidos)/sum(table2019$fallecidos)

table2019$rk2019=as.numeric(row.names(table2019))
table2019$pareto2019=0
table2019[table2019$cum2019<=0.8,'pareto2019']=1
names(table2019)[3]="fallecidos2019"
table2019$año=NULL

###
table2020=sindat_tabla_prov[sindat_tabla_prov$año==2020,]
table2020=table2020[order(-table2020$fallecidos),]

table2020$cum2020=cumsum(table2020$fallecidos)/sum(table2020$fallecidos)

table2020$rk2020=as.numeric(row.names(table2020))
table2020$pareto2020=0
table2020[table2020$cum2020<=0.8,'pareto2020']=1
names(table2020)[3]="fallecidos2020"
table2020$año=NULL

###
table2021=sindat_tabla_prov[sindat_tabla_prov$año==2021,]
table2021=table2021[order(-table2021$fallecidos),]

table2021$cum2021=cumsum(table2021$fallecidos)/sum(table2021$fallecidos)

table2021$rk2021=as.numeric(row.names(table2021))
table2021$pareto2021=0
table2021[table2021$cum2021<=0.8,'pareto2021']=1
names(table2021)[3]="fallecidos2021"
table2021$año=NULL

dfPareto=merge(table2017,table2018)
dfPareto=merge(dfPareto,table2019)
dfPareto=merge(dfPareto,table2020)
dfPareto=merge(dfPareto,table2021)
sumer=c("pareto2017","pareto2018","pareto2019","pareto2020","pareto2021")
dfPareto$queda=apply(dfPareto[,sumer],1,sum)
dfPareto=dfPareto[dfPareto$queda>=1,]

dfPareto=dfPareto[order(dfPareto$rk2017),]
row.names(dfPareto)=NULL

tableParetoALL=as.data.frame(apply(dfPareto[,sumer],2,sum))
tableParetoALL$año=row.names(tableParetoALL)
row.names(tableParetoALL)=NULL
names(tableParetoALL)[1]='conteo'
tableParetoALL=tableParetoALL[,c(2,1)]
tableParetoALL$año=gsub("pareto","",tableParetoALL$año)
tableParetoALL$Cumple_Pareto=ifelse(tableParetoALL$conteo>=40,'No','Sí')

saveRDS(tableParetoALL,file="tableParetoALL.rds")


```





```{r}
sindat_anual_prov=sindat[sindat$año>=2020,]
sindat_anual_prov=sindat_anual_prov%>%group_by(año,semana,anosem, PROVINCIA) %>%
   summarize(fallecidos=length(semana))

sindat_anual_prov1=sindat_anual_prov[sindat_anual_prov$año==2020,]%>%group_by(PROVINCIA) %>%mutate(cum=cumsum(fallecidos))
sindat_anual_prov2=sindat_anual_prov[sindat_anual_prov$año==2021,]%>%group_by(PROVINCIA) %>%mutate(cum=cumsum(fallecidos))

provdata=rio::import("dataProvincias.xlsx")

sindat_anual_prov1=merge(sindat_anual_prov1,provdata[,c("prov","pob")],by.x = "PROVINCIA",by.y = "prov")
sindat_anual_prov1$morbilidad=sindat_anual_prov1$cum/sindat_anual_prov1$pob
sel2020=table2020[table2020$pareto2020==1,"PROVINCIA"]$PROVINCIA

sindat_anual_prov2=merge(sindat_anual_prov2,provdata[,c("prov","pob")],by.x = "PROVINCIA",by.y = "prov")
sindat_anual_prov2$morbilidad=sindat_anual_prov2$cum/sindat_anual_prov2$pob
sel2021=table2021[table2021$pareto2021==1,"PROVINCIA"]$PROVINCIA

sindat_anual_prov1$pareto20=0
sindat_anual_prov1$pareto20=ifelse(sindat_anual_prov1$PROVINCIA%in%sel2020,1,0)
sindat_anual_prov1pareto=sindat_anual_prov1[sindat_anual_prov1$pareto20==1,]
sindat_anual_prov1pareto=sindat_anual_prov1pareto%>%
   group_by(PROVINCIA,año) %>%
   mutate(top=semana[which.max(fallecidos)])
sindat_anual_prov1pareto$gruposem=cut(sindat_anual_prov1pareto$top,breaks = c(0,20,24,31,60),
    labels =c("Antes semana 20", 
              "Sem 20-24",
              "Sem 25-30",
              "Luego semana 30"),ordered_result = T)
saveRDS(sindat_anual_prov1pareto,file="sindat_anual_prov1pareto.rds")

sindat_anual_prov2$pareto21=0
sindat_anual_prov2$pareto21=ifelse(sindat_anual_prov2$PROVINCIA%in%sel2021,1,0)
sindat_anual_prov2pareto=sindat_anual_prov2[sindat_anual_prov2$pareto21==1,]
sindat_anual_prov2pareto=sindat_anual_prov2pareto%>%
   group_by(PROVINCIA,año) %>%
   mutate(top=semana[which.max(fallecidos)])
sindat_anual_prov2pareto$gruposem=cut(sindat_anual_prov2pareto$top,breaks = c(0,5,10,14,30),
    labels =c("Antes semana 5", 
              "Sem 6-10",
              "Sem 11-14",
              "Luego semana 14"),ordered_result = T)
saveRDS(sindat_anual_prov2pareto,file="sindat_anual_prov2pareto.rds")
```





```{r}

sindat=readRDS("sinadef.rds")
library(lubridate)
library(magrittr)
library(dplyr)

sindat_sem=sindat%>%
            group_by(año,semana) %>%summarize(
      primera_Linea=length(ocupa_primera[ocupa_primera==1]),
      otra_Actividad=length(ocupa_primera[ocupa_primera==0]),
      primera_Linea_Covid=length(ocupa_primera[ocupa_primera==1 & CORONAVIRU==1]),
      otra_Actividad_Covid=length(ocupa_primera[ocupa_primera==0 & CORONAVIRU==1]))



sindat_sem=melt(sindat_sem, id.vars = c("año","semana"))
sindat_sem=dcast(sindat_sem, semana ~ año + variable)
#names(sindat_sem)
priVar=paste(2017:2019,"primera_Linea",sep="_")
priCVar=paste(2017:2019,"primera_Linea_Covid",sep="_")
otVar=paste(2017:2019,"otra_Actividad",sep="_")
otCVar=paste(2017:2019,"otra_Actividad_Covid",sep="_")

sindat_sem$antes_2020_primera_Linea=apply(sindat_sem[,priVar],1,mean)
sindat_sem$antes_2020_primera_Linea_Covid=apply(sindat_sem[,priCVar],1,mean)
sindat_sem$antes_2020_otra_Actividad=apply(sindat_sem[,otVar],1,mean)
sindat_sem$antes_2020_otra_Actividad_Covid=apply(sindat_sem[,otCVar],1,mean)


sindat_sem=sindat_sem[,c(1,grep("antes|2020|2021",
                            names(sindat_sem)))]
sindat_sem=melt(sindat_sem,id.vars = c("semana"))

con_c=levels(sindat_sem$variable)[grep("_Covid",levels(sindat_sem$variable))]
sin_c=setdiff(levels(sindat_sem$variable),con_c)


sindat_sem$variable=as.character(sindat_sem$variable)
sindat_sem=sindat_sem[complete.cases(sindat_sem),]
sindat_sem_sin=sindat_sem[sindat_sem$variable%in%sin_c,]
sindat_sem_cov=sindat_sem[sindat_sem$variable%in%con_c,]

saveRDS(sindat_sem_sin,file="sindat_sem_sin.rds")
saveRDS(sindat_sem_cov,file="sindat_sem_cov.rds")
```

```{r}
sindat=readRDS("sinadef.rds")
```

```{r}
library(lubridate)
library(magrittr)
library(dplyr)


allCovid=sindat[sindat$CORONAVIRU==1,]

allCovid_sem=allCovid%>%
            group_by(año,semana) %>%summarize(
      otraActividad_Covid=length(Cate[Cate==0]),
      salud_Covid=length(Cate[Cate==1]),
      seguridad_Covid=length(Cate[Cate==2]))



allCovid_sem=melt(allCovid_sem, id.vars = c("año","semana"))


saveRDS(allCovid_sem,file="allCovid_sem.rds")

```

```{r}
sindat=readRDS("sinadef.rds")
```

```{r}
library(lubridate)
library(magrittr)
library(dplyr)


allCovid=sindat[sindat$CORONAVIRU==1,]

allCovid_sem_Lug=allCovid%>%
            group_by(año,semana) %>%summarize(
                
      Lima_Otra_Actividad=length(CateLug[CateLug==10]),
      Lima_Salud=length(CateLug[CateLug==11]),
      Lima_Seguridad=length(CateLug[CateLug==12]),
      NO_Lima_Otra_Actividad=length(CateLug[CateLug==20]),
      NO_Lima_Salud=length(CateLug[CateLug==21]),
      NO_Lima_Seguridad=length(CateLug[CateLug==22]))


allCovid_sem_Lug=melt(allCovid_sem_Lug, id.vars = c("año","semana"))


saveRDS(allCovid_sem_Lug,file="allCovid_sem_Lug.rds")

```


```{r}
sindat=readRDS("sinadef.rds")
```

```{r}
library(lubridate)
library(magrittr)
library(dplyr)


allCovid=sindat[sindat$CORONAVIRU==1,]

allCovid_sem_geo=allCovid%>%
            group_by(año,semana,anosem,DEPARTAMEN) %>%summarize(
                
      Otra_Actividad=length(Cate[Cate==0]),
      PrimeraLinea=length(Cate[Cate>=1]))


allCovid_sem_geo=melt(allCovid_sem_geo, id.vars = c("año","semana","anosem","DEPARTAMEN"))
allCovid_sem_geo$anosem=as.ordered(allCovid_sem_geo$anosem)

saveRDS(allCovid_sem_geo,file="allCovid_sem_geo.rds")

```




